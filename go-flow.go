package main

import (
	"encoding/base64"
	"flag"
	"fmt"
	"io/ioutil"
	"strings"
	"text/template"

	"github.com/gogap/builder"
	"github.com/gogap/config"
	"github.com/urfave/cli"
)

const (
	flowTempl = "cGFja2FnZSBtYWluCgppbXBvcnQgKAoJImJ5dGVzIgoJImVuY29kaW5nL2pzb24iCgkiZm10IgoJImlvL2lvdXRpbCIKCSJvcyIKCSJzdHJpbmdzIgoKCSJnaXRodWIuY29tL2dvZ2FwL2NvbmZpZyIKCSJnaXRodWIuY29tL2dvZ2FwL2NvbnRleHQiCgkiZ2l0aHViLmNvbS9nb2dhcC9mbG93IgoJImdpdGh1Yi5jb20vZ29nYXAvbG9ncnVzX21hdGUiCgkiZ2l0aHViLmNvbS9zaXJ1cHNlbi9sb2dydXMiCgkiZ2l0aHViLmNvbS91cmZhdmUvY2xpIgopCgp2YXIgKAoJY29uZmlnU3RyID0ge3suY29uZmlnX3N0cn19CikKCmZ1bmMgbWFpbigpIHsKCgljb25mIDo9IGNvbmZpZy5OZXdDb25maWcoCgkJY29uZmlnLkNvbmZpZ1N0cmluZyhjb25maWdTdHIpLAoJKQoKCWFwcENvbmYgOj0gY29uZi5HZXRDb25maWcoImFwcCIpCgoJYXBwIDo9IGNsaS5OZXdBcHAoKQoKCWFwcC5WZXJzaW9uID0gYXBwQ29uZi5HZXRTdHJpbmcoInZlcnNpb24iLCAiMC4wLjAiKQoJYXBwLkF1dGhvciA9IGFwcENvbmYuR2V0U3RyaW5nKCJhdXRob3IiKQoJYXBwLk5hbWUgPSBhcHBDb25mLkdldFN0cmluZygibmFtZSIsICJhcHAiKQoJYXBwLlVzYWdlID0gYXBwQ29uZi5HZXRTdHJpbmcoInVzYWdlIikKCWFwcC5IZWxwTmFtZSA9IGFwcC5OYW1lCgoJaWYgYXBwLlZlcnNpb24gPT0gIjAuMC4wIiB7CgkJYXBwLkhpZGVWZXJzaW9uID0gdHJ1ZQoJfQoKCWNvbW1hbmRzQ29uZiA6PSBhcHBDb25mLkdldENvbmZpZygiY29tbWFuZHMiKQoKCWZvciBfLCBrZXkgOj0gcmFuZ2UgY29tbWFuZHNDb25mLktleXMoKSB7CgkJZ2VuZXJhdGVDb21tYW5kcygmYXBwLkNvbW1hbmRzLCBrZXksIGNvbW1hbmRzQ29uZi5HZXRDb25maWcoa2V5KSkKCX0KCglhcHAuUnVuQW5kRXhpdE9uRXJyb3IoKQoKCXJldHVybgp9CgpmdW5jIG5ld0FjdGlvbihuYW1lIHN0cmluZywgY29uZiBjb25maWcuQ29uZmlndXJhdGlvbikgY2xpLkFjdGlvbkZ1bmMgewoKCXJldHVybiBmdW5jKGN0eCAqY2xpLkNvbnRleHQpIChlcnIgZXJyb3IpIHsKCgkJZXJyID0gbG9hZEVOVihjdHgpCgoJCWlmIGVyciAhPSBuaWwgewoJCQlyZXR1cm4KCQl9CgoJCWRpc2FibGVTdGVwcyA6PSBjdHguU3RyaW5nU2xpY2UoImRpc2FibGUiKQoJCWNvbmZpZ0ZpbGVzIDo9IGN0eC5TdHJpbmdTbGljZSgiY29uZmlnIikKCgkJZGVmYXVsdENvbmYgOj0gY29uZi5HZXRDb25maWcoImRlZmF1bHQtY29uZmlnIikKCgkJbWFwQ29uZmlncyA6PSBtYXBbc3RyaW5nXWNvbmZpZy5Db25maWd1cmF0aW9uewoJCQkiZGVmYXVsdC1jb25maWciOiBkZWZhdWx0Q29uZiwKCQl9CgoJCWZvciBfLCBjb25maWdBcmcgOj0gcmFuZ2UgY29uZmlnRmlsZXMgewoJCQl2IDo9IHN0cmluZ3MuU3BsaXROKGNvbmZpZ0FyZywgIjoiLCAyKQoJCQlpZiBsZW4odikgPT0gMSB7CgkJCQlhcmdzQ29uZmlnIDo9IGNvbmZpZy5OZXdDb25maWcoY29uZmlnLkNvbmZpZ0ZpbGUodlswXSkpCgkJCQltYXBDb25maWdzWyJkZWZhdWx0LWNvbmZpZyJdID0gYXJnc0NvbmZpZwoJCQl9IGVsc2UgaWYgbGVuKHYpID09IDIgewoJCQkJYXJnc0NvbmZpZyA6PSBjb25maWcuTmV3Q29uZmlnKGNvbmZpZy5Db25maWdGaWxlKHZbMV0pKQoJCQkJbWFwQ29uZmlnc1t2WzBdXSA9IGFyZ3NDb25maWcKCQkJfQoJCX0KCgkJZGVmYXVsdENvbmYgPSBtYXBDb25maWdzWyJkZWZhdWx0LWNvbmZpZyJdCgoJCWxvZ2dlckNvbmYgOj0gZGVmYXVsdENvbmYuR2V0Q29uZmlnKCJsb2dnZXIiKQoKCQlsb2dydXNfbWF0ZS5IaWphY2soCgkJCWxvZ3J1cy5TdGFuZGFyZExvZ2dlcigpLAoJCQlsb2dydXNfbWF0ZS5XaXRoQ29uZmlnKGxvZ2dlckNvbmYpLAoJCSkKCgkJZmxvd0N0eCA6PSBjb250ZXh0Lk5ld0NvbnRleHQoKQoKCQljdHhMaXN0IDo9IGN0eC5TdHJpbmdTbGljZSgiY3R4IikKCQljdHhGaWxlcyA6PSBjdHguU3RyaW5nU2xpY2UoImN0eC1maWxlIikKCgkJbG9hZENvbnRleHQoY3R4TGlzdCwgY3R4RmlsZXMsIGZsb3dDdHgpCgoJCWlucHV0RmlsZXMgOj0gY3R4LlN0cmluZ1NsaWNlKCJpbnB1dCIpCgoJCWZvciBfLCBpbnB1dEZpbGUgOj0gcmFuZ2UgaW5wdXRGaWxlcyB7CgkJCXZhciBpbnB1dEZpbGVEYXRhIFtdYnl0ZQoJCQlpbnB1dEZpbGVEYXRhLCBlcnIgPSBpb3V0aWwuUmVhZEZpbGUoaW5wdXRGaWxlKQoJCQlpZiBlcnIgIT0gbmlsIHsKCQkJCXJldHVybgoJCQl9CgoJCQl2YXIgbmFtZVZhbHVlcyBbXWZsb3cuTmFtZVZhbHVlCgkJCWVyciA9IGpzb24uVW5tYXJzaGFsKGlucHV0RmlsZURhdGEsICZuYW1lVmFsdWVzKQoJCQlpZiBlcnIgIT0gbmlsIHsKCQkJCXJldHVybgoJCQl9CgoJCQlmbG93LkFwcGVuZE91dHB1dChmbG93Q3R4LCBuYW1lVmFsdWVzLi4uKQoJCX0KCgkJdHJhbnMgOj0gZmxvdy5CZWdpbihmbG93Q3R4LCBjb25maWcuV2l0aENvbmZpZyhkZWZhdWx0Q29uZikpCgoJCWZsb3dMaXN0IDo9IGNvbmYuR2V0U3RyaW5nTGlzdCgiZmxvdyIpCgoJCWZsb3dJdGVtQ29uZmlnIDo9IGNvbmYuR2V0Q29uZmlnKCJjb25maWciKQoKCQltYXBEaXNhYmVsU3RlcHMgOj0gbWFwW3N0cmluZ11ib29se30KCgkJZm9yIF8sIHN0ZXAgOj0gcmFuZ2UgZGlzYWJsZVN0ZXBzIHsKCQkJbWFwRGlzYWJlbFN0ZXBzW3N0ZXBdID0gdHJ1ZQoJCX0KCgkJZm9yIF8sIGl0ZW0gOj0gcmFuZ2UgZmxvd0xpc3QgewoKCQkJaGFuZGxlckFuZENvbmYgOj0gc3RyaW5ncy5TcGxpdE4oaXRlbSwgIkAiLCAyKQoKCQkJbmFtZSA6PSAiIgoJCQljb25maWdOYW1lIDo9ICIiCgoJCQlpZiBsZW4oaGFuZGxlckFuZENvbmYpID09IDIgewoJCQkJbmFtZSA9IGhhbmRsZXJBbmRDb25mWzBdCgkJCQljb25maWdOYW1lID0gaGFuZGxlckFuZENvbmZbMV0KCQkJfSBlbHNlIHsKCQkJCW5hbWUgPSBoYW5kbGVyQW5kQ29uZlswXQoJCQl9CgoJCQlpZiBtYXBEaXNhYmVsU3RlcHNbaXRlbV0gewoJCQkJY29udGludWUKCQkJfQoKCQkJaWYgbGVuKGNvbmZpZ05hbWUpID4gMCB7CgkJCQloYW5kbGVyQ29uZiA6PSBmbG93SXRlbUNvbmZpZy5HZXRDb25maWcoY29uZmlnTmFtZSkKCgkJCQlpZiBoQ29uZiwgZXhpc3QgOj0gbWFwQ29uZmlnc1tjb25maWdOYW1lXTsgZXhpc3QgewoJCQkJCWhhbmRsZXJDb25mID0gaENvbmYKCQkJCX0KCgkJCQl0cmFucy5UaGVuKG5hbWUsIGNvbmZpZy5XaXRoQ29uZmlnKGhhbmRsZXJDb25mKSkKCQkJfSBlbHNlIHsKCQkJCXRyYW5zLlRoZW4obmFtZSkKCQkJfQoJCX0KCgkJZXJyID0gdHJhbnMuQ29tbWl0KCkKCgkJaWYgZXJyICE9IG5pbCB7CgkJCXJldHVybgoJCX0KCgkJcXVpZXQgOj0gY3R4LkJvb2woInF1aWV0IikKCQlvdXRwdXQgOj0gY3R4LlN0cmluZygib3V0cHV0IikKCgkJaWYgIXF1aWV0IHx8IGxlbihvdXRwdXQpID4gMCB7CgoJCQluYW1lVmFsdWVzIDo9IHRyYW5zLk91dHB1dCgpCgoJCQl2YXIgb3V0ZGF0YSBbXWJ5dGUKCQkJb3V0ZGF0YSwgZXJyID0ganNvbi5NYXJzaGFsSW5kZW50KAoJCQkJbmFtZVZhbHVlcywKCQkJCSIiLAoJCQkJIiAgICAiKQoKCQkJaWYgZXJyICE9IG5pbCB7CgkJCQlyZXR1cm4KCQkJfQoKCQkJaWYgbGVuKG91dHB1dCkgPT0gMCB7CgkJCQlpZiBsZW4obmFtZVZhbHVlcykgPiAwIHsKCQkJCQlmbXQuUHJpbnRsbihzdHJpbmcob3V0ZGF0YSkpCgkJCQl9CgkJCX0gZWxzZSB7CgkJCQllcnIgPSBpb3V0aWwuV3JpdGVGaWxlKG91dHB1dCwgb3V0ZGF0YSwgMDY0NCkKCQkJCWlmIGVyciAhPSBuaWwgewoJCQkJCXJldHVybgoJCQkJfQoJCQl9CgkJfQoKCQlyZXR1cm4KCX0KfQoKZnVuYyBsb2FkRU5WKGN0eCAqY2xpLkNvbnRleHQpIChlcnIgZXJyb3IpIHsKCWVudnMgOj0gY3R4LlN0cmluZ1NsaWNlKCJlbnYiKQoJZW52RmlsZXMgOj0gY3R4LlN0cmluZ1NsaWNlKCJlbnYtZmlsZSIpCgoJaWYgbGVuKGVudnMpID09IDAgJiYgbGVuKGVudkZpbGVzKSA9PSAwIHsKCQlyZXR1cm4KCX0KCgltYXBFTlYgOj0gbWFwW3N0cmluZ11zdHJpbmd7fQoKCWZvciBfLCBlbnYgOj0gcmFuZ2UgZW52cyB7CgkJdiA6PSBzdHJpbmdzLlNwbGl0TihlbnYsICI6IiwgMikKCQlpZiBsZW4odikgIT0gMiB7CgkJCWVyciA9IGZtdC5FcnJvcmYoImVudiBmb3JtYXQgZXJyb3I6JXMiLCBlbnYpCgkJCXJldHVybgoJCX0KCgkJbWFwRU5WW3ZbMF1dID0gdlsxXQoJfQoKCWZvciBfLCBmIDo9IHJhbmdlIGVudkZpbGVzIHsKCgkJdmFyIGRhdGEgW11ieXRlCgkJZGF0YSwgZXJyID0gaW91dGlsLlJlYWRGaWxlKGYpCgkJaWYgZXJyICE9IG5pbCB7CgkJCXJldHVybgoJCX0KCgkJYnVmIDo9IGJ5dGVzLk5ld0J1ZmZlcihkYXRhKQoJCWRlY29kZXIgOj0ganNvbi5OZXdEZWNvZGVyKGJ1ZikKCQlkZWNvZGVyLlVzZU51bWJlcigpCgoJCXRtcE1hcCA6PSBtYXBbc3RyaW5nXXN0cmluZ3t9CgkJZXJyID0gZGVjb2Rlci5EZWNvZGUoJnRtcE1hcCkKCQlpZiBlcnIgIT0gbmlsIHsKCQkJcmV0dXJuCgkJfQoKCQlmb3IgaywgdiA6PSByYW5nZSB0bXBNYXAgewoJCQltYXBFTlZba10gPSB2CgkJfQoJfQoKCWZvciBrLCB2IDo9IHJhbmdlIG1hcEVOViB7CgkJb3MuU2V0ZW52KGssIHYpCgl9CgoJcmV0dXJuCn0KCmZ1bmMgbG9hZENvbnRleHQoY3R4TGlzdCBbXXN0cmluZywgY3R4RmlsZXMgW11zdHJpbmcsIGZsb3dDdHggY29udGV4dC5Db250ZXh0KSAoZXJyIGVycm9yKSB7CgoJaWYgbGVuKGN0eExpc3QpID09IDAgJiYgbGVuKGN0eEZpbGVzKSA9PSAwIHsKCQlyZXR1cm4KCX0KCgltYXBDdHggOj0gbWFwW3N0cmluZ11zdHJpbmd7fQoKCWZvciBfLCBjIDo9IHJhbmdlIGN0eExpc3QgewoJCXYgOj0gc3RyaW5ncy5TcGxpdE4oYywgIjoiLCAyKQoJCWlmIGxlbih2KSAhPSAyIHsKCQkJZXJyID0gZm10LkVycm9yZigiY3R4IGZvcm1hdCBlcnJvcjolcyIsIGMpCgkJCXJldHVybgoJCX0KCgkJbWFwQ3R4W3ZbMF1dID0gdlsxXQoJfQoKCWZvciBfLCBmIDo9IHJhbmdlIGN0eEZpbGVzIHsKCgkJdmFyIGRhdGEgW11ieXRlCgkJZGF0YSwgZXJyID0gaW91dGlsLlJlYWRGaWxlKGYpCgkJaWYgZXJyICE9IG5pbCB7CgkJCXJldHVybgoJCX0KCgkJYnVmIDo9IGJ5dGVzLk5ld0J1ZmZlcihkYXRhKQoJCWRlY29kZXIgOj0ganNvbi5OZXdEZWNvZGVyKGJ1ZikKCQlkZWNvZGVyLlVzZU51bWJlcigpCgoJCXRtcE1hcCA6PSBtYXBbc3RyaW5nXXN0cmluZ3t9CgkJZXJyID0gZGVjb2Rlci5EZWNvZGUoJnRtcE1hcCkKCQlpZiBlcnIgIT0gbmlsIHsKCQkJcmV0dXJuCgkJfQoKCQlmb3IgaywgdiA6PSByYW5nZSB0bXBNYXAgewoJCQltYXBDdHhba10gPSB2CgkJfQoJfQoKCWZvciBrLCB2IDo9IHJhbmdlIG1hcEN0eCB7CgkJZmxvd0N0eC5XaXRoVmFsdWUoaywgdikKCX0KCglyZXR1cm4KfQoKZnVuYyBnZW5lcmF0ZUNvbW1hbmRzKGNtZHMgKltdY2xpLkNvbW1hbmQsIG5hbWUgc3RyaW5nLCBjb25mIGNvbmZpZy5Db25maWd1cmF0aW9uKSB7CgoJa2V5cyA6PSBjb25mLktleXMoKQoKCWlmIGxlbihrZXlzKSA9PSAwIHsKCQlyZXR1cm4KCX0KCglvYmpDb3VudCA6PSAwCglmb3IgXywga2V5IDo9IHJhbmdlIGtleXMgewoJCWlmIGNvbmYuSXNPYmplY3Qoa2V5KSB8fCBrZXkgPT0gInVzYWdlIiB7CgkJCW9iakNvdW50KysKCQl9Cgl9CgoJLy8gQ29tbWFuZAoJaWYgb2JqQ291bnQgIT0gbGVuKGtleXMpIHsKCQkqY21kcyA9IGFwcGVuZCgqY21kcywKCQkJY2xpLkNvbW1hbmR7CgkJCQlOYW1lOiAgbmFtZSwKCQkJCVVzYWdlOiBjb25mLkdldFN0cmluZygidXNhZ2UiKSwKCQkJCUZsYWdzOiBbXWNsaS5GbGFnewoJCQkJCWNsaS5TdHJpbmdTbGljZUZsYWd7CgkJCQkJCU5hbWU6ICAiZGlzYWJsZSwgZCIsCgkJCQkJCVVzYWdlOiAiZGlzYWJsZSBzdGVwcywgZS5nLjogLWQgZGV2b3BzLmFsaXl1bi5jcy5jbHVzdGVyLmRlbGV0ZWQud2FpdCAtZCBkZXZvcHMuYWxpeXVuLmNzLmNsdXN0ZXIucnVubmluZy53YWl0IiwKCQkJCQl9LAoJCQkJCWNsaS5TdHJpbmdTbGljZUZsYWd7CgkJCQkJCU5hbWU6ICAiY29uZmlnLCBjIiwKCQkJCQkJVXNhZ2U6ICJ1c2Ugc3BlY2lmaWVkIGNvbmZpZyB0byBkZWZhdWx0IGNvbmZpZyIsCgkJCQkJfSwKCQkJCQljbGkuU3RyaW5nU2xpY2VGbGFnewoJCQkJCQlOYW1lOiAgImVudiIsCgkJCQkJCVVzYWdlOiAiZS5nLjogLS1lbnYgVVNFUjp0ZXN0IC0tZW52IFBXRDphc2RmIiwKCQkJCQl9LAoJCQkJCWNsaS5TdHJpbmdTbGljZUZsYWd7CgkJCQkJCU5hbWU6ICAiY3R4IiwKCQkJCQkJVXNhZ2U6ICJlLmcuOiAtLWN0eCBjb2RlOmdvZ2FwIC0tZW52IGhlbGxvOndvcmxkIiwKCQkJCQl9LAoJCQkJCWNsaS5TdHJpbmdTbGljZUZsYWd7CgkJCQkJCU5hbWU6ICAiZW52LWZpbGUiLAoJCQkJCQlVc2FnZTogImUuZy46IC0tZW52LWZpbGUgYS5qc29uIC0tZW52LWZpbGUgYi5qc29uIiwKCQkJCQl9LAoJCQkJCWNsaS5TdHJpbmdTbGljZUZsYWd7CgkJCQkJCU5hbWU6ICAiaW5wdXQsIGkiLAoJCQkJCQlVc2FnZTogImlucHV0IGZpbGUgZnJvbSBvdGhlcidzIG91dHB1dCBmb3IgaW5pdCB0aGlzIGZsb3csIGUuZy46IC1pIG91dHB1dDEuanNvbiAtaSBvdXRwdXQyLmpzb24iLAoJCQkJCX0sCgkJCQkJY2xpLlN0cmluZ0ZsYWd7CgkJCQkJCU5hbWU6ICAib3V0cHV0LCBvIiwKCQkJCQkJVXNhZ2U6ICJmaWxlbmFtZSBvZiBvdXRwdXQiLAoJCQkJCX0sCgkJCQkJY2xpLkJvb2xGbGFnewoJCQkJCQlOYW1lOiAgInF1aWV0LCBxIiwKCQkJCQkJVXNhZ2U6ICJiZSBxdWlldCwgbm8gb3V0cHV0IGRhdGEgcHJpbnQiLAoJCQkJCX0sCgkJCQl9LAoJCQkJQWN0aW9uOiBuZXdBY3Rpb24obmFtZSwgY29uZiksCgkJCX0sCgkJKQoKCQlyZXR1cm4KCX0KCgl2YXIgc3ViQ29tbWFuZHMgW11jbGkuQ29tbWFuZAoKCWZvciBfLCBrZXkgOj0gcmFuZ2UgY29uZi5LZXlzKCkgewoKCQlpZiBrZXkgPT0gInVzYWdlIiB7CgkJCWNvbnRpbnVlCgkJfQoKCQlnZW5lcmF0ZUNvbW1hbmRzKCZzdWJDb21tYW5kcywga2V5LCBjb25mLkdldENvbmZpZyhrZXkpKQoKCX0KCgljdXJyZW50Q29tbWFuZCA6PSBjbGkuQ29tbWFuZHsKCQlOYW1lOiAgICAgICAgbmFtZSwKCQlVc2FnZTogICAgICAgY29uZi5HZXRTdHJpbmcoInVzYWdlIiksCgkJU3ViY29tbWFuZHM6IHN1YkNvbW1hbmRzLAoJfQoKCSpjbWRzID0gYXBwZW5kKCpjbWRzLCBjdXJyZW50Q29tbWFuZCkKfQo="
)

func main() {
	app := cli.NewApp()

	app.Name = "go-flow"
	app.HelpName = "go-flow"
	app.HideVersion = true

	app.Commands = cli.Commands{
		cli.Command{
			Name:  "build",
			Usage: "build your own flow into binary",
			Flags: []cli.Flag{
				cli.StringFlag{
					Name:  "config",
					Usage: "flow config file",
				},
			},
			Action: build,
		},

		cli.Command{
			Name:  "run",
			Usage: "run flow",
			Flags: []cli.Flag{
				cli.StringFlag{
					Name:  "config",
					Usage: "flow config file",
				},
			},
			Action:          run,
			SkipFlagParsing: true,
			SkipArgReorder:  true,
		},
	}

	app.Flags = []cli.Flag{
		cli.BoolFlag{
			Name:  "verbose, v",
			Usage: "be verbose",
		},
	}

	app.RunAndExitOnError()
}

func createBuilder(appName string, verboseOfGoBuild, verboseOfGoGet bool, conf config.Configuration) (bu *builder.Builder, err error) {

	argsConf := ""

	if verboseOfGoGet {
		argsConf += "go-get = [\"-v\"]\n"
	}

	if verboseOfGoBuild {
		argsConf += "go-build = [\"-v\"]\n"
	}

	buildConfStr := fmt.Sprintf(`%s {
packages = %s
build.args {
    %s
  }
}`, appName,
		toPkgList(conf.GetStringList("packages")),
		argsConf,
	)

	goTmpl, err := base64.StdEncoding.DecodeString(flowTempl)
	if err != nil {
		return
	}

	tmpl, err := template.New(appName).Parse(string(goTmpl))
	if err != nil {
		return
	}

	b, err := builder.NewBuilder(
		builder.ConfigString(buildConfStr),
		builder.Template(tmpl),
	)

	if err != nil {
		return
	}

	bu = b
	return
}

func toPkgList(list []string) string {

	var values []string

	for _, item := range list {
		values = append(values, fmt.Sprintf("\"%s\"", item))
	}

	return "[" + strings.Join(values, ",") + "]"
}

func build(ctx *cli.Context) (err error) {

	configFile := ctx.String("config")

	if len(configFile) == 0 {
		err = fmt.Errorf("please input config file")
		return
	}

	conf := config.NewConfig(config.ConfigFile(configFile))

	appName := conf.GetString("app.name", "app")

	verbose := ctx.Parent().Bool("verbose")

	b, err := createBuilder(appName, verbose, verbose, conf)
	if err != nil {
		return
	}

	configData, err := ioutil.ReadFile(configFile)
	if err != nil {
		return
	}

	err = b.Build(map[string]interface{}{"config_str": fmt.Sprintf("`%s`", string(configData))}, appName)

	return
}

func run(ctx *cli.Context) (err error) {

	set := flag.NewFlagSet("run", 0)

	confArg := set.String("config", "", "flow config file")

	err = set.Parse(ctx.Args()[0:2])
	if err != nil {
		return
	}

	configFile := *confArg

	if len(configFile) == 0 {
		err = fmt.Errorf("please input config file")
		return
	}

	conf := config.NewConfig(config.ConfigFile(configFile))

	appName := conf.GetString("app.name", "app")

	verbose := ctx.Parent().Bool("verbose")

	b, err := createBuilder(appName, false, verbose, conf)
	if err != nil {
		return
	}

	configData, err := ioutil.ReadFile(configFile)
	if err != nil {
		return
	}

	err = b.Run(map[string]interface{}{"config_str": fmt.Sprintf("`%s`", string(configData))}, appName, ctx.Args()[2:])

	return
}
