package main

import (
	"encoding/base64"
	"flag"
	"fmt"
	"io/ioutil"
	"strings"
	"text/template"

	"github.com/gogap/builder"
	"github.com/gogap/config"
	"github.com/urfave/cli"
)

const (
	flowTempl = "cGFja2FnZSBtYWluCgppbXBvcnQgKAoJImJ5dGVzIgoJImVuY29kaW5nL2Jhc2U2NCIKCSJlbmNvZGluZy9qc29uIgoJImZtdCIKCSJpbyIKCSJpby9pb3V0aWwiCgkibmV0L3VybCIKCSJvcyIKCSJzdHJjb252IgoJInN0cmluZ3MiCgoJImdpdGh1Yi5jb20vZ29nYXAvY29uZmlnIgoJImdpdGh1Yi5jb20vZ29nYXAvY29udGV4dCIKCSJnaXRodWIuY29tL2dvZ2FwL2Zsb3ciCgkiZ2l0aHViLmNvbS9nb2dhcC9sb2dydXNfbWF0ZSIKCSJnaXRodWIuY29tL3NpcnVwc2VuL2xvZ3J1cyIKCSJnaXRodWIuY29tL3VyZmF2ZS9jbGkiCikKCnZhciAoCgljb25maWdTdHIgPSB7ey5jb25maWdfc3RyfX0KKQoKZnVuYyBpbml0KCkgewoJaWYgbGVuKGNvbmZpZ1N0cikgPiAwIHsKCQljb25maWdTdHJEYXRhLCBlcnIgOj0gYmFzZTY0LlN0ZEVuY29kaW5nLkRlY29kZVN0cmluZyhjb25maWdTdHIpCgkJaWYgZXJyICE9IG5pbCB7CgkJCWVyciA9IGZtdC5FcnJvcmYoImRlY29kZSBjb25maWcgc3RyIGZhaWx1cmU6ICVzXG4iLCBlcnIuRXJyb3IoKSkKCQkJcGFuaWMoZXJyKQoJCX0KCQljb25maWdTdHIgPSBzdHJpbmcoY29uZmlnU3RyRGF0YSkKCX0KfQoKZnVuYyBtYWluKCkgewoKCWNvbmYgOj0gY29uZmlnLk5ld0NvbmZpZygKCQljb25maWcuQ29uZmlnU3RyaW5nKGNvbmZpZ1N0ciksCgkpCgoJYXBwQ29uZiA6PSBjb25mLkdldENvbmZpZygiYXBwIikKCglhcHAgOj0gY2xpLk5ld0FwcCgpCgoJYXBwLlZlcnNpb24gPSBhcHBDb25mLkdldFN0cmluZygidmVyc2lvbiIsICIwLjAuMCIpCglhcHAuQXV0aG9yID0gYXBwQ29uZi5HZXRTdHJpbmcoImF1dGhvciIpCglhcHAuTmFtZSA9IGFwcENvbmYuR2V0U3RyaW5nKCJuYW1lIiwgImFwcCIpCglhcHAuVXNhZ2UgPSBhcHBDb25mLkdldFN0cmluZygidXNhZ2UiKQoJYXBwLkhlbHBOYW1lID0gYXBwLk5hbWUKCglpZiBhcHAuVmVyc2lvbiA9PSAiMC4wLjAiIHsKCQlhcHAuSGlkZVZlcnNpb24gPSB0cnVlCgl9CgoJY29tbWFuZHNDb25mIDo9IGFwcENvbmYuR2V0Q29uZmlnKCJjb21tYW5kcyIpCgoJZm9yIF8sIGtleSA6PSByYW5nZSBjb21tYW5kc0NvbmYuS2V5cygpIHsKCQlnZW5lcmF0ZUNvbW1hbmRzKCZhcHAuQ29tbWFuZHMsIGtleSwgY29tbWFuZHNDb25mLkdldENvbmZpZyhrZXkpKQoJfQoKCWFwcC5SdW5BbmRFeGl0T25FcnJvcigpCgoJcmV0dXJuCn0KCmZ1bmMgbmV3QWN0aW9uKG5hbWUgc3RyaW5nLCBjb25mIGNvbmZpZy5Db25maWd1cmF0aW9uKSBjbGkuQWN0aW9uRnVuYyB7CgoJcmV0dXJuIGZ1bmMoY3R4ICpjbGkuQ29udGV4dCkgKGVyciBlcnJvcikgewoKCQllcnIgPSBsb2FkRU5WKGN0eCkKCgkJaWYgZXJyICE9IG5pbCB7CgkJCXJldHVybgoJCX0KCgkJc2tpcFN0ZXBzIDo9IGN0eC5TdHJpbmdTbGljZSgic2tpcCIpCgkJY29uZmlnRmlsZXMgOj0gY3R4LlN0cmluZ1NsaWNlKCJjb25maWciKQoJCWxvZ0NvbmZpZ0ZpbGUgOj0gY3R4LlN0cmluZygibG9nLWNvbmZpZyIpCgoJCWRlZmF1bHRDb25mIDo9IGNvbmYuR2V0Q29uZmlnKCJkZWZhdWx0LWNvbmZpZyIpCgoJCW1hcENvbmZpZ0ZpbGUgOj0gbWFwW3N0cmluZ11zdHJpbmd7fQoKCQlmb3IgXywgY29uZmlnQXJnIDo9IHJhbmdlIGNvbmZpZ0ZpbGVzIHsKCQkJdiA6PSBzdHJpbmdzLlNwbGl0Tihjb25maWdBcmcsICI6IiwgMikKCQkJaWYgbGVuKHYpID09IDEgewoJCQkJbWFwQ29uZmlnRmlsZVsiZGVmYXVsdCJdID0gdlswXQoJCQl9IGVsc2UgaWYgbGVuKHYpID09IDIgewoJCQkJbWFwQ29uZmlnRmlsZVt2WzBdXSA9IHZbMV0KCQkJfQoJCX0KCgkJaWYgbGVuKGxvZ0NvbmZpZ0ZpbGUpID4gMCB7CgkJCWxvZ3J1c19tYXRlLkhpamFjaygKCQkJCWxvZ3J1cy5TdGFuZGFyZExvZ2dlcigpLAoJCQkJbG9ncnVzX21hdGUuQ29uZmlnRmlsZShsb2dDb25maWdGaWxlKSwKCQkJKQoJCX0KCgkJZmxvd0N0eCA6PSBjb250ZXh0Lk5ld0NvbnRleHQoKQoKCQljdHhMaXN0IDo9IGN0eC5TdHJpbmdTbGljZSgiY3R4IikKCQljdHhGaWxlcyA6PSBjdHguU3RyaW5nU2xpY2UoImN0eC1maWxlIikKCgkJbG9hZENvbnRleHQoY3R4TGlzdCwgY3R4RmlsZXMsIGZsb3dDdHgpCgoJCWlucHV0RmlsZXMgOj0gY3R4LlN0cmluZ1NsaWNlKCJpbnB1dCIpCgoJCWZvciBfLCBpbnB1dEZpbGUgOj0gcmFuZ2UgaW5wdXRGaWxlcyB7CgkJCXZhciBpbnB1dEZpbGVEYXRhIFtdYnl0ZQoJCQlpbnB1dEZpbGVEYXRhLCBlcnIgPSBpb3V0aWwuUmVhZEZpbGUoaW5wdXRGaWxlKQoJCQlpZiBlcnIgIT0gbmlsIHsKCQkJCXJldHVybgoJCQl9CgoJCQl2YXIgbmFtZVZhbHVlcyBbXWZsb3cuTmFtZVZhbHVlCgkJCWVyciA9IGpzb24uVW5tYXJzaGFsKGlucHV0RmlsZURhdGEsICZuYW1lVmFsdWVzKQoJCQlpZiBlcnIgIT0gbmlsIHsKCQkJCXJldHVybgoJCQl9CgoJCQlmbG93LkFwcGVuZE91dHB1dChmbG93Q3R4LCBuYW1lVmFsdWVzLi4uKQoJCX0KCgkJdHJhbnMgOj0gZmxvdy5CZWdpbihmbG93Q3R4LCBjb25maWcuV2l0aENvbmZpZyhkZWZhdWx0Q29uZikpCgoJCWZsb3dMaXN0IDo9IGNvbmYuR2V0U3RyaW5nTGlzdCgiZmxvdyIpCgoJCWZsb3dJdGVtQ29uZmlnIDo9IGNvbmYuR2V0Q29uZmlnKCJjb25maWciKQoKCQltYXBTa2lwU3RlcHMgOj0gbWFwW3N0cmluZ11ib29se30KCgkJZm9yIF8sIHN0ZXAgOj0gcmFuZ2Ugc2tpcFN0ZXBzIHsKCQkJbWFwU2tpcFN0ZXBzW3N0ZXBdID0gdHJ1ZQoJCX0KCgkJZm9yIGksIHN0clVSTCA6PSByYW5nZSBmbG93TGlzdCB7CgoJCQl2YXIgZmxvd1VSTCAqdXJsLlVSTAoJCQlmbG93VVJMLCBlcnIgPSB1cmwuUGFyc2UoImZsb3c6Ly8iICsgc3RyVVJMKQoKCQkJbmFtZSA6PSBmbG93VVJMLkhvc3QKCgkJCWlkIDo9IGZsb3dVUkwuUXVlcnkoKS5HZXQoImlkIikKCQkJY2xhc3MgOj0gZmxvd1VSTC5RdWVyeSgpLkdldCgiY2xhc3MiKQoKCQkJaWYgbGVuKGlkKSA9PSAwIHsKCQkJCWlkID0gc3RyY29udi5JdG9hKGkpCgkJCX0KCgkJCWlmIGxlbihjbGFzcykgPT0gMCB7CgkJCQljbGFzcyA9ICJkZWZhdWx0IgoJCQl9CgoJCQlpZiBtYXBTa2lwU3RlcHNbaWRdIHsKCQkJCWNvbnRpbnVlCgkJCX0KCgkJCWlmIGNvbmZpZ0ZpbGUsIGV4aXN0IDo9IG1hcENvbmZpZ0ZpbGVbY2xhc3NdOyBleGlzdCB7CgkJCQl0cmFucy5UaGVuKG5hbWUsIGNvbmZpZy5Db25maWdGaWxlKGNvbmZpZ0ZpbGUpKQoJCQl9IGVsc2UgaWYgZmxvd0l0ZW1Db25maWcuSGFzUGF0aChjbGFzcykgewoJCQkJaGFuZGxlckNvbmYgOj0gZmxvd0l0ZW1Db25maWcuR2V0Q29uZmlnKGNsYXNzKQoJCQkJdHJhbnMuVGhlbihuYW1lLCBjb25maWcuV2l0aENvbmZpZyhoYW5kbGVyQ29uZikpCgkJCX0gZWxzZSB7CgkJCQl0cmFucy5UaGVuKG5hbWUpCgkJCX0KCQl9CgoJCW91dHB1dCA6PSBjdHguU3RyaW5nKCJvdXRwdXQiKQoKCQlzbmFwc2hvdEVudnNCZWdpbiA6PSBvcy5FbnZpcm9uKCkKCgkJZXJyID0gdHJhbnMuQ29tbWl0KCkKCgkJc25hcHNob3RFbnZzRW5kIDo9IG9zLkVudmlyb24oKQoKCQlkZWx0YUVudiA6PSBkZWx0YUVudnMoc25hcHNob3RFbnZzQmVnaW4sIHNuYXBzaG90RW52c0VuZCkKCgkJZHVtcEVudkZpbGUgOj0gY3R4LlN0cmluZygiZHVtcC1lbnYiKQoKCQlwcmludFRvU1REIDo9IG1hcFtzdHJpbmddaW50ZXJmYWNle317fQoKCQlpZiBsZW4oZHVtcEVudkZpbGUpID4gMCB7CgoJCQlkdW1wRW52RGF0YSwgZXJyTWFyc2hhbCA6PSBqc29uLk1hcnNoYWxJbmRlbnQoCgkJCQlkZWx0YUVudiwKCQkJCSIiLAoJCQkJIiAgICAiKQoKCQkJaWYgZXJyTWFyc2hhbCAhPSBuaWwgewoJCQkJcmV0dXJuCgkJCX0KCgkJCWVycldyaXRlIDo9IGlvdXRpbC5Xcml0ZUZpbGUoZHVtcEVudkZpbGUsIGR1bXBFbnZEYXRhLCAwNjQ0KQoJCQlpZiBlcnJXcml0ZSAhPSBuaWwgewoJCQkJcmV0dXJuCgkJCX0KCQl9CgoJCWlmIGN0eC5Cb29sKCJwcmludC1lbnYiKSB7CgkJCXByaW50VG9TVERbImVudmlyb25tZW50Il0gPSBkZWx0YUVudgoJCX0KCgkJbmFtZVZhbHVlcyA6PSB0cmFucy5PdXRwdXQoKQoKCQlpZiBjdHguQm9vbCgicHJpbnQtb3V0cHV0IikgewoJCQlwcmludFRvU1REWyJvdXRwdXQiXSA9IG5hbWVWYWx1ZXMKCQl9CgoJCWlmIGxlbihvdXRwdXQpID4gMCB7CgkJCW91dGRhdGEsIGVyck1hcnNoYWwgOj0ganNvbi5NYXJzaGFsSW5kZW50KAoJCQkJbmFtZVZhbHVlcywKCQkJCSIiLAoJCQkJIiAgICAiKQoKCQkJaWYgZXJyTWFyc2hhbCAhPSBuaWwgewoJCQkJcmV0dXJuCgkJCX0KCgkJCWVycldyaXRlIDo9IGlvdXRpbC5Xcml0ZUZpbGUob3V0cHV0LCBvdXRkYXRhLCAwNjQ0KQoJCQlpZiBlcnJXcml0ZSAhPSBuaWwgewoJCQkJcmV0dXJuCgkJCX0KCQl9CgoJCWlmIGxlbihwcmludFRvU1REKSA+IDAgewoJCQlwcmludERhdGEsIGVyck1hcnNoYWwgOj0ganNvbi5NYXJzaGFsSW5kZW50KAoJCQkJcHJpbnRUb1NURCwKCQkJCSIiLAoJCQkJIiAgICAiKQoKCQkJcHJpbnREYXRhID0gYXBwZW5kKHByaW50RGF0YSwgJ1xuJykKCgkJCWlvLkNvcHkob3MuU3Rkb3V0LCBieXRlcy5OZXdSZWFkZXIocHJpbnREYXRhKSkKCgkJCWlmIGVyck1hcnNoYWwgIT0gbmlsIHsKCQkJCXJldHVybgoJCQl9CgkJfQoKCQlpZiBlcnIgIT0gbmlsIHsKCQkJcmV0dXJuCgkJfQoKCQlyZXR1cm4KCX0KfQoKZnVuYyBkZWx0YUVudnMoZW52c0EsIGVudnNCIFtdc3RyaW5nKSBtYXBbc3RyaW5nXXN0cmluZyB7CgoJbWFwRW52c0EgOj0gbWFwW3N0cmluZ11zdHJpbmd7fQoKCW1hcEVudnNEZWx0YSA6PSBtYXBbc3RyaW5nXXN0cmluZ3t9CgoJZm9yIF8sIHYgOj0gcmFuZ2UgZW52c0EgewoJCWVudiA6PSBzdHJpbmdzLlNwbGl0Tih2LCAiPSIsIDIpCgkJaWYgbGVuKGVudikgIT0gMiB7CgkJCWNvbnRpbnVlCgkJfQoKCQltYXBFbnZzQVtlbnZbMF1dID0gZW52WzFdCgl9CgoJZm9yIF8sIHYgOj0gcmFuZ2UgZW52c0IgewoJCWVudiA6PSBzdHJpbmdzLlNwbGl0Tih2LCAiPSIsIDIpCgkJaWYgbGVuKGVudikgIT0gMiB7CgkJCWNvbnRpbnVlCgkJfQoKCQllbnZBVmFsdWUsIGV4aXN0IDo9IG1hcEVudnNBW2VudlswXV0KCgkJaWYgIWV4aXN0IHsKCQkJbWFwRW52c0RlbHRhW2VudlswXV0gPSBlbnZbMV0KCQl9IGVsc2UgaWYgZW52QVZhbHVlICE9IGVudlsxXSB7CgkJCW1hcEVudnNEZWx0YVtlbnZbMF1dID0gZW52WzFdCgkJfQoJfQoKCXJldHVybiBtYXBFbnZzRGVsdGEKfQoKZnVuYyBsb2FkRU5WKGN0eCAqY2xpLkNvbnRleHQpIChlcnIgZXJyb3IpIHsKCWVudnMgOj0gY3R4LlN0cmluZ1NsaWNlKCJlbnYiKQoJZW52RmlsZXMgOj0gY3R4LlN0cmluZ1NsaWNlKCJlbnYtZmlsZSIpCgoJaWYgbGVuKGVudnMpID09IDAgJiYgbGVuKGVudkZpbGVzKSA9PSAwIHsKCQlyZXR1cm4KCX0KCgltYXBFTlYgOj0gbWFwW3N0cmluZ11zdHJpbmd7fQoKCWZvciBfLCBlbnYgOj0gcmFuZ2UgZW52cyB7CgkJdiA6PSBzdHJpbmdzLlNwbGl0TihlbnYsICI6IiwgMikKCQlpZiBsZW4odikgIT0gMiB7CgkJCWVyciA9IGZtdC5FcnJvcmYoImVudiBmb3JtYXQgZXJyb3I6JXMiLCBlbnYpCgkJCXJldHVybgoJCX0KCgkJbWFwRU5WW3ZbMF1dID0gdlsxXQoJfQoKCWZvciBfLCBmIDo9IHJhbmdlIGVudkZpbGVzIHsKCgkJdmFyIGRhdGEgW11ieXRlCgkJZGF0YSwgZXJyID0gaW91dGlsLlJlYWRGaWxlKGYpCgkJaWYgZXJyICE9IG5pbCB7CgkJCXJldHVybgoJCX0KCgkJYnVmIDo9IGJ5dGVzLk5ld0J1ZmZlcihkYXRhKQoJCWRlY29kZXIgOj0ganNvbi5OZXdEZWNvZGVyKGJ1ZikKCQlkZWNvZGVyLlVzZU51bWJlcigpCgoJCXRtcE1hcCA6PSBtYXBbc3RyaW5nXXN0cmluZ3t9CgkJZXJyID0gZGVjb2Rlci5EZWNvZGUoJnRtcE1hcCkKCQlpZiBlcnIgIT0gbmlsIHsKCQkJcmV0dXJuCgkJfQoKCQlmb3IgaywgdiA6PSByYW5nZSB0bXBNYXAgewoJCQltYXBFTlZba10gPSB2CgkJfQoJfQoKCWZvciBrLCB2IDo9IHJhbmdlIG1hcEVOViB7CgkJb3MuU2V0ZW52KGssIHYpCgl9CgoJcmV0dXJuCn0KCmZ1bmMgbG9hZENvbnRleHQoY3R4TGlzdCBbXXN0cmluZywgY3R4RmlsZXMgW11zdHJpbmcsIGZsb3dDdHggY29udGV4dC5Db250ZXh0KSAoZXJyIGVycm9yKSB7CgoJaWYgbGVuKGN0eExpc3QpID09IDAgJiYgbGVuKGN0eEZpbGVzKSA9PSAwIHsKCQlyZXR1cm4KCX0KCgltYXBDdHggOj0gbWFwW3N0cmluZ11zdHJpbmd7fQoKCWZvciBfLCBjIDo9IHJhbmdlIGN0eExpc3QgewoJCXYgOj0gc3RyaW5ncy5TcGxpdE4oYywgIjoiLCAyKQoJCWlmIGxlbih2KSAhPSAyIHsKCQkJZXJyID0gZm10LkVycm9yZigiY3R4IGZvcm1hdCBlcnJvcjolcyIsIGMpCgkJCXJldHVybgoJCX0KCgkJbWFwQ3R4W3ZbMF1dID0gdlsxXQoJfQoKCWZvciBfLCBmIDo9IHJhbmdlIGN0eEZpbGVzIHsKCgkJdmFyIGRhdGEgW11ieXRlCgkJZGF0YSwgZXJyID0gaW91dGlsLlJlYWRGaWxlKGYpCgkJaWYgZXJyICE9IG5pbCB7CgkJCXJldHVybgoJCX0KCgkJYnVmIDo9IGJ5dGVzLk5ld0J1ZmZlcihkYXRhKQoJCWRlY29kZXIgOj0ganNvbi5OZXdEZWNvZGVyKGJ1ZikKCQlkZWNvZGVyLlVzZU51bWJlcigpCgoJCXRtcE1hcCA6PSBtYXBbc3RyaW5nXXN0cmluZ3t9CgkJZXJyID0gZGVjb2Rlci5EZWNvZGUoJnRtcE1hcCkKCQlpZiBlcnIgIT0gbmlsIHsKCQkJcmV0dXJuCgkJfQoKCQlmb3IgaywgdiA6PSByYW5nZSB0bXBNYXAgewoJCQltYXBDdHhba10gPSB2CgkJfQoJfQoKCWZvciBrLCB2IDo9IHJhbmdlIG1hcEN0eCB7CgkJZmxvd0N0eC5XaXRoVmFsdWUoaywgdikKCX0KCglyZXR1cm4KfQoKZnVuYyBnZW5lcmF0ZUNvbW1hbmRzKGNtZHMgKltdY2xpLkNvbW1hbmQsIG5hbWUgc3RyaW5nLCBjb25mIGNvbmZpZy5Db25maWd1cmF0aW9uKSB7CgoJa2V5cyA6PSBjb25mLktleXMoKQoKCWlmIGxlbihrZXlzKSA9PSAwIHsKCQlyZXR1cm4KCX0KCglvYmpDb3VudCA6PSAwCglmb3IgXywga2V5IDo9IHJhbmdlIGtleXMgewoJCWlmIGNvbmYuSXNPYmplY3Qoa2V5KSB8fCBrZXkgPT0gInVzYWdlIiB7CgkJCW9iakNvdW50KysKCQl9Cgl9CgoJLy8gQ29tbWFuZAoJaWYgb2JqQ291bnQgIT0gbGVuKGtleXMpIHsKCQkqY21kcyA9IGFwcGVuZCgqY21kcywKCQkJY2xpLkNvbW1hbmR7CgkJCQlOYW1lOiAgbmFtZSwKCQkJCVVzYWdlOiBjb25mLkdldFN0cmluZygidXNhZ2UiKSwKCQkJCUZsYWdzOiBbXWNsaS5GbGFnewoJCQkJCWNsaS5TdHJpbmdTbGljZUZsYWd7CgkJCQkJCU5hbWU6ICAic2tpcCwgcyIsCgkJCQkJCVVzYWdlOiAic2tpcCBzdGVwcyBieSBpZCwgZS5nLjogLXMgMCAtcyBzdGVwQSIsCgkJCQkJfSwKCQkJCQljbGkuU3RyaW5nU2xpY2VGbGFnewoJCQkJCQlOYW1lOiAgImNvbmZpZywgYyIsCgkJCQkJCVVzYWdlOiAibWFwcGluZyBjb25maWcgdG8gZmxvdyBjbGFzcywgZS5nLjogLS1jb25maWcgZGVmYXVsdC5jb25mIC0tY29uZmlnIGNsYXNzQTpzdGVwQS5jb25mIiwKCQkJCQl9LAoJCQkJCWNsaS5TdHJpbmdTbGljZUZsYWd7CgkJCQkJCU5hbWU6ICAiZW52IiwKCQkJCQkJVXNhZ2U6ICJlLmcuOiAtLWVudiBVU0VSOnRlc3QgLS1lbnYgUFdEOmFzZGYiLAoJCQkJCX0sCgkJCQkJY2xpLlN0cmluZ1NsaWNlRmxhZ3sKCQkJCQkJTmFtZTogICJjdHgiLAoJCQkJCQlVc2FnZTogImUuZy46IC0tY3R4IGNvZGU6Z29nYXAgLS1lbnYgaGVsbG86d29ybGQiLAoJCQkJCX0sCgkJCQkJY2xpLlN0cmluZ1NsaWNlRmxhZ3sKCQkJCQkJTmFtZTogICJlbnYtZmlsZSIsCgkJCQkJCVVzYWdlOiAiZS5nLjogLS1lbnYtZmlsZSBhLmpzb24gLS1lbnYtZmlsZSBiLmpzb24iLAoJCQkJCX0sCgkJCQkJY2xpLlN0cmluZ1NsaWNlRmxhZ3sKCQkJCQkJTmFtZTogICJpbnB1dCwgaSIsCgkJCQkJCVVzYWdlOiAiaW5wdXQgZmlsZSBmcm9tIG90aGVyJ3Mgb3V0cHV0IGZvciBpbml0IHRoaXMgZmxvdywgZS5nLjogLWkgb3V0cHV0MS5qc29uIC1pIG91dHB1dDIuanNvbiIsCgkJCQkJfSwKCQkJCQljbGkuU3RyaW5nRmxhZ3sKCQkJCQkJTmFtZTogICJvdXRwdXQsIG8iLAoJCQkJCQlVc2FnZTogImZpbGVuYW1lIG9mIG91dHB1dCIsCgkJCQkJfSwKCQkJCQljbGkuQm9vbEZsYWd7CgkJCQkJCU5hbWU6ICAicHJpbnQtb3V0cHV0IiwKCQkJCQkJVXNhZ2U6ICJwcmludCBvdXRwdXQgdG8gc3RkIiwKCQkJCQl9LAoJCQkJCWNsaS5TdHJpbmdGbGFnewoJCQkJCQlOYW1lOiAgImR1bXAtZW52IiwKCQkJCQkJVXNhZ2U6ICJkdW1wIGRlbHRhIGVudiBkYXRhIHRvIGZpbGUiLAoJCQkJCX0sCgkJCQkJY2xpLkJvb2xGbGFnewoJCQkJCQlOYW1lOiAgInByaW50LWVudiIsCgkJCQkJCVVzYWdlOiAicHJpbnQgZGVsdGEgZW52IGRhdGEgdG8gc3RkIiwKCQkJCQl9LAoJCQkJCWNsaS5TdHJpbmdGbGFnewoJCQkJCQlOYW1lOiAgImxvZy1jb25maWciLAoJCQkJCQlVc2FnZTogImxvZ3Vyc19tYXRlIGxvZ2dlcidzIGNvbmZpZyIsCgkJCQkJfSwKCQkJCX0sCgkJCQlBY3Rpb246IG5ld0FjdGlvbihuYW1lLCBjb25mKSwKCQkJfSwKCQkpCgoJCXJldHVybgoJfQoKCXZhciBzdWJDb21tYW5kcyBbXWNsaS5Db21tYW5kCgoJZm9yIF8sIGtleSA6PSByYW5nZSBjb25mLktleXMoKSB7CgoJCWlmIGtleSA9PSAidXNhZ2UiIHsKCQkJY29udGludWUKCQl9CgoJCWdlbmVyYXRlQ29tbWFuZHMoJnN1YkNvbW1hbmRzLCBrZXksIGNvbmYuR2V0Q29uZmlnKGtleSkpCgoJfQoKCWN1cnJlbnRDb21tYW5kIDo9IGNsaS5Db21tYW5kewoJCU5hbWU6ICAgICAgICBuYW1lLAoJCVVzYWdlOiAgICAgICBjb25mLkdldFN0cmluZygidXNhZ2UiKSwKCQlTdWJjb21tYW5kczogc3ViQ29tbWFuZHMsCgl9CgoJKmNtZHMgPSBhcHBlbmQoKmNtZHMsIGN1cnJlbnRDb21tYW5kKQp9Cg=="
)

func main() {
	app := cli.NewApp()

	app.Name = "go-flow"
	app.HelpName = "go-flow"
	app.HideVersion = true

	app.Commands = cli.Commands{
		cli.Command{
			Name:  "build",
			Usage: "build your own flow into binary",
			Flags: []cli.Flag{
				cli.StringFlag{
					Name:  "config",
					Usage: "flow config file",
				},
			},
			Action: build,
		},

		cli.Command{
			Name:  "run",
			Usage: "run flow",
			Flags: []cli.Flag{
				cli.StringFlag{
					Name:  "config",
					Usage: "flow config file",
				},
			},
			Action:          run,
			SkipFlagParsing: true,
			SkipArgReorder:  true,
		},
	}

	app.Flags = []cli.Flag{
		cli.BoolFlag{
			Name:  "verbose, v",
			Usage: "be verbose",
		},
	}

	app.RunAndExitOnError()
}

func createBuilder(appName string, verboseOfGoBuild, verboseOfGoGet bool, conf config.Configuration) (bu *builder.Builder, err error) {

	argsConf := ""

	if verboseOfGoGet {
		argsConf += "go-get = [\"-v\"]\n"
	}

	if verboseOfGoBuild {
		argsConf += "go-build = [\"-v\"]\n"
	}

	buildConfStr := fmt.Sprintf(`%s {
packages = %s
build.args {
    %s
  }
}`, appName,
		toPkgList(conf.GetStringList("packages")),
		argsConf,
	)

	goTmpl, err := base64.StdEncoding.DecodeString(flowTempl)
	if err != nil {
		return
	}

	tmpl, err := template.New(appName).Parse(string(goTmpl))
	if err != nil {
		return
	}

	b, err := builder.NewBuilder(
		builder.ConfigString(buildConfStr),
		builder.Template(tmpl),
	)

	if err != nil {
		return
	}

	bu = b
	return
}

func toPkgList(list []string) string {

	var values []string

	for _, item := range list {
		values = append(values, fmt.Sprintf("\"%s\"", item))
	}

	return "[" + strings.Join(values, ",") + "]"
}

func build(ctx *cli.Context) (err error) {

	configFile := ctx.String("config")

	if len(configFile) == 0 {
		err = fmt.Errorf("please input config file")
		return
	}

	conf := config.NewConfig(config.ConfigFile(configFile))

	appName := conf.GetString("app.name", "app")

	verbose := ctx.Parent().Bool("verbose")

	b, err := createBuilder(appName, verbose, verbose, conf)
	if err != nil {
		return
	}

	configData, err := ioutil.ReadFile(configFile)
	if err != nil {
		return
	}

	err = b.Build(map[string]interface{}{"config_str": fmt.Sprintf("`%s`", string(configData))}, appName)

	return
}

func run(ctx *cli.Context) (err error) {

	set := flag.NewFlagSet("run", 0)

	confArg := set.String("config", "", "flow config file")

	err = set.Parse(ctx.Args()[0:2])
	if err != nil {
		return
	}

	configFile := *confArg

	if len(configFile) == 0 {
		err = fmt.Errorf("please input config file")
		return
	}

	conf := config.NewConfig(config.ConfigFile(configFile))

	appName := conf.GetString("app.name", "app")

	verbose := ctx.Parent().Bool("verbose")

	b, err := createBuilder(appName, false, verbose, conf)
	if err != nil {
		return
	}

	configData, err := ioutil.ReadFile(configFile)
	if err != nil {
		return
	}

	base64ConfStr := base64.StdEncoding.EncodeToString(configData)

	err = b.Run(map[string]interface{}{"config_str": fmt.Sprintf("`%s`", base64ConfStr)}, appName, ctx.Args()[2:])

	return
}
